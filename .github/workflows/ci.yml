name: Tests

on: [push, pull_request]

jobs:
  unit_tests:
    name: unit tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            rev: nightly
            manager: sudo apt-get
            packages: -y ripgrep
          - os: ubuntu-22.04
            rev: v0.9.0
            manager: sudo apt-get
            packages: -y ripgrep
          - os: macos-12
            rev: nightly
            manager: brew
            packages: ripgrep
          - os: macos-12
            rev: v0.9.0
            manager: brew
            packages: ripgrep
          - os: windows-2022
            rev: nightly
            manager: choco
            packages: ripgrep
          - os: windows-2022
            rev: v0.9.0
            manager: choco
            packages: ripgrep

    steps:
      - uses: actions/checkout@v4

      - run: date +%F > todays-date

      - uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: ${{ matrix.rev }}

      - name: Restore from todays cache
        uses: actions/cache@v3
        with:
          path: deps
          key: ${{ runner.os }}-deps-${{ matrix.version }}-${{ hashFiles('todays-date') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ matrix.version }}-


      - name: Install ripgrep
        run: |
          ${{ matrix.manager }} update
          ${{ matrix.manager }} install ${{ matrix.packages }}
          rg --version

      - name: Run tests
        run: |
          nvim --version
          make test
